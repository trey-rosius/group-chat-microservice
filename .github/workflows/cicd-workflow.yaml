name: Deploy the CDK Infrastructure and Build the Catalyst Service Images

on:
  push:
    branches:
        - main

jobs:
  setup-diagrid-project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@master
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      # Install Diagrid CLI
      - name: Install Diagrid CLI
        run: |
          # Download the latest Diagrid CLI from GitHub or direct source
          curl -o- https://downloads.diagrid.io/cli/install.sh | bash
          sudo mv ./diagrid /usr/local/bin
      # Log into Diagrid
      - name: Log Into Diagrid
        run: |
          diagrid login --api-key ${{secrets.DIAGRID_API_KEY}}
      # Diagrid Version
      - name: Diagrid Version
        run: |
          diagrid version
      - name: Create Diagrid Project
        run: |
          diagrid project create ${{secrets.DIAGRID_PROJECT}}
      - name: Create Diagrid APP IDS
        run: |
          for service in ./services/*/ ; do
            service_name=$(basename "$service")
            diagrid appid create -p ${{secrets.DIAGRID_PROJECT}} $service_name
            sleep 10
          done
      - name: Creating Dynamodb Tables
        run: |
          for service in ./services/*/ ; do
            service_name=$(basename "$service")
            echo "DynamoDB table name : ${service_name}-table"
            table_name="${service_name}-table"
            aws dynamodb create-table --table-name $table_name --attribute-definitions AttributeName=key,AttributeType=S --key-schema AttributeName=key,KeyType=HASH --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5
          done
      - name: Check App Status
        run: |
          for service in ./services/*/ ; do
            service_name=$(basename "$service")
            diagrid appid get $service_name -p ${{secrets.DIAGRID_PROJECT}}
          done

      - name: Create Pub/Sub Component
        run: |
          diagrid component create aws-pubsub --type pubsub.aws.snssqs --metadata accessKey=${{ secrets.AWS_ACCESS_KEY_ID }} --metadata secretKey=${{ secrets.AWS_SECRET_ACCESS_KEY }} --metadata awsRegion=${{ secrets.AWS_DEFAULT_REGION }} --project ${{ secrets.DIAGRID_PROJECT }}
      - name: Create State Component
        run: |
          for service in ./services/*/ ; do
            service_name=$(basename "$service")
            table_name="${service_name}-table"
            sleep 10
            diagrid component create $table_name --type state.aws.dynamodb --metadata accessKey=${{ secrets.AWS_ACCESS_KEY_ID }} --metadata secretKey=${{ secrets.AWS_SECRET_ACCESS_KEY }} --metadata awsRegion=${{ secrets.AWS_DEFAULT_REGION }} --metadata table=$table_name --scopes $service_name --project ${{secrets.DIAGRID_PROJECT}}
         done
      - name: Creating subscriptions
        run: |
          cat ./group_subs.yaml
          diagrid subscriptions apply --wait --file ./group_subs.yaml
          

